[![Build Status](https://travis-ci.org/apaganobeleno/authentic.svg?branch=master)](https://travis-ci.org/apaganobeleno/authentic)

### Authentic

Authentic is a library to implement username/password authentication easier in [Buffalo](https://github.com/gobuffalo/buffalo).

#### Demo application

Youn can find a demo application on the `example` folder, its a simple app that checks username and password authentication.

To get it running you need to get into that folder and run:

```
$ buffalo db create
$ buffalo db migrate
$ buffalo db:seed
```

After that you can run the `buffalo dev` command and as usual you can check it on `localhost:3000`.

Default username/password generated are `test@test.com` and `password123`.

#### Adding Authentic to your Buffalo app

#### Authenticable Model

First of all you need an `Authenticable` model, or said in other words a model that implements the `authentic.Authenticable` interface, this interface is composed by 2 functions:

```go
type Authenticable interface {
    EncryptedPassword() string
	GetID() interface{}
}
```

So as an example your model could look like:

```go
type User struct {
	ID        uuid.UUID `json:"id" db:"id"`
	CreatedAt time.Time `json:"created_at" db:"created_at"`
	UpdatedAt time.Time `json:"updated_at" db:"updated_at"`

	Email             string `json:"email" db:"email"`
    //IMPORTANT: Plain password should not be stored in the database.
	Password          string `json:"-" db:"-"`
	EncryptedPassword string `json:"-" db:"encrypted_password"`
}

func (u User) GetEncryptedPassword() string {
	return u.EncryptedPassword
}

func (u User) GetID() interface{} {
	return u.ID
}
```

Where User is our model, generated by the `buffalo db g model` command, few things to note here, that are important:

- Password field should not be stored into the database (notice struct tags)
- Table should have a column to store encrypted passwords (encrypted_password in this case)
- There should also be field (any type) to identify the user, this field should be unique and probably something like the row ID could be used.

#### Implement your Provider

You will also need to implement an `authentic.Provider`, this provider file is usually in your `actions` folder, `authentic.Provider` interface has the following shape:

```go
type Provider interface {

	//FindByID receives a userID and should check if the user exist,
	//this will be used by the AuthenticateMW for protected routes requests.
	FindByID(userID interface{}) (Authenticable, error)

	//FindByUsername will be called when authorizing a username by username/password
	//this allows applications to relate the username password with the form to the
	//desired field to look for the user.
	FindByUsername(username string) (Authenticable, error)

	//UserDetails Allows App using Authentic to load details of the user
	//on every request after we've determined the user exists, this function
	//will be called on every request by Authentic.
	UserDetails(user Authenticable, c buffalo.Context) error
}
```

And as an example you could implement your `authentic.Provider` like:

```go
type AuthProvider struct{}

func (ap AuthProvider) FindByID(id interface{}) (authentic.Authenticable, error) {
	tx := models.DB

	user := models.User{}
	error := tx.Find(&user, id)

	if error != nil {
		return nil, errors.WithStack(error)
	}

	return user, nil
}

func (ap AuthProvider) FindByUsername(username string) (authentic.Authenticable, error) {
	var user models.User
	err := models.DB.Where("email = ?", username).First(&user)
	if err != nil {
		return user, err
	}

	return user, nil
}

func (ap AuthProvider) UserDetails(u authentic.Authenticable, c buffalo.Context) error {
	user := u.(models.User)
	c.Set("user", map[string]interface{}{
		"email": user.Email,
	})

	return nil
}
```

Which will contain the logic to:

- Find a user by its ID
- Find a user by username
- Process every request details set, this is usually used to show information of the user on the layout or other sort of user based experience.

#### Setup your app

Last step is to setup your app, this means to tell your app to use authentic, to do so, simply in your `app.go` you can set the following code (or similar according to your needs):

```go
//actions/app.go
func App() *buffalo.App {
    if app == nil {
		app = buffalo.Automatic(buffalo.Options{
			Env:         ENV,
			SessionName: "_example_session",
		})
        
        ... //Many other things.

		//Sets up authentic filters and handlers
		authentic.Setup(app, AuthProvider{}, authentic.Config{
			LoginPath:       "/auth/login", //Path where the login will be
			AfterLoginPath:  "/secure/home", //URL where the user will be redirected after login.
			AfterLogoutPath: "/", //URL where the user will be redirected after logout.
			PublicHandlers: []buffalo.Handler{ //Handlers that should not be secured by authentic.
				HomeHandler,
			},
		})
        ... //Many other things
    }
}
```

With that you will have authentic all set.
